angular.module("ui.rCalendar.tpls",["template/rcalendar/calendar.html","template/rcalendar/week.html"]),angular.module("ui.rCalendar",["ui.rCalendar.tpls"]).constant("calendarConfig",{formatDay:"dd",formatDayHeader:"EEE",formatDayTitle:"MMMM dd, yyyy",formatWeekTitle:"MMMM yyyy, w",formatMonthTitle:"MMMM yyyy",formatWeekViewDayHeader:"EEE d",formatHourColumn:"ha",calendarMode:"month",showWeeks:!1,showEventDetail:!0,startingDay:0,eventSource:null,queryMode:"local"}).controller("ui.rCalendar.CalendarController",["$scope","$attrs","$parse","$interpolate","$log","dateFilter","calendarConfig",function(e,t,a,n,r,l,o){"use strict";function i(e,t){return!(e.endIndex<=t.startIndex||t.endIndex<=e.startIndex)}function d(e){var t,a,n,r=e.length,l=0,o=new Array(r);for(t=0;r>t;t+=1){for(n=0;l>n;n+=1)o[n]=!1;for(a=0;t>a;a+=1)i(e[t],e[a])&&(o[e[a].position]=!0);for(n=0;l>n&&o[n];n+=1);l>n?e[t].position=n:e[t].position=l++}}function s(e){var t,a,n,r,l,o,i,d=new Array(24);for(e.sort(function(e,t){return t.position-e.position}),n=0;24>n;n+=1)d[n]={calculated:!1,events:[]};for(l=e.length,n=0;l>n;n+=1)for(t=e[n],a=t.startIndex;a<t.endIndex;)d[a].events.push(t),a+=1;for(n=0;l>n;){if(t=e[n],!t.overlapNumber){var s=t.position+1;t.overlapNumber=s;for(var c=[t];t=c.shift();)for(a=t.startIndex;a<t.endIndex;){if(!d[a].calculated&&(d[a].calculated=!0,d[a].events))for(o=d[a].events.length,r=0;o>r;r+=1)i=d[a].events[r],i.overlapNumber||(i.overlapNumber=s,c.push(i));a+=1}}n+=1}}var c=this,u={$setViewValue:angular.noop};angular.forEach(["formatDay","formatDayHeader","formatDayTitle","formatWeekTitle","formatMonthTitle","formatWeekViewDayHeader","formatHourColumn","showWeeks","showEventDetail","startingDay","eventSource","queryMode"],function(a,r){c[a]=angular.isDefined(t[a])?7>r?n(t[a])(e.$parent):e.$parent.$eval(t[a]):o[a]}),e.$parent.$watch(t.eventSource,function(e){c.onEventSourceChanged(e)}),e.calendarMode=e.calendarMode||o.calendarMode,angular.isDefined(t.initDate)&&(c.currentCalendarDate=e.$parent.$eval(t.initDate)),c.currentCalendarDate||(c.currentCalendarDate=new Date,t.ngModel&&!e.$parent.$eval(t.ngModel)&&a(t.ngModel).assign(e.$parent,c.currentCalendarDate)),c.init=function(e){u=e,u.$render=function(){c.render()}},c.render=function(){if(u.$modelValue){var e=new Date(u.$modelValue),t=!isNaN(e);t?this.currentCalendarDate=e:r.error('"ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.'),u.$setValidity("date",t)}this.refreshView()},c.refreshView=function(){this.mode&&(this.range=this._getRange(this.currentCalendarDate),this._refreshView(),this.rangeChanged())},c.split=function(e,t){for(var a=[];e.length>0;)a.push(e.splice(0,t));return a},c.onEventSourceChanged=function(e){c.eventSource=e,c._onDataLoaded&&c._onDataLoaded()},e.move=function(t){var a,n=c.mode.step,r=c.currentCalendarDate,l=r.getFullYear()+t*(n.years||0),o=r.getMonth()+t*(n.months||0),i=r.getDate()+t*(n.days||0);r.setFullYear(l,o,i),"month"===e.calendarMode&&(a=new Date(l,o+1,1),a.getTime()<=r.getTime()&&(c.currentCalendarDate=new Date(a-864e5))),u.$setViewValue(c.currentCalendarDate),c.refreshView()},c.move=function(t){e.move(t)},c.rangeChanged=function(){"local"===c.queryMode?c.eventSource&&c._onDataLoaded&&c._onDataLoaded():"remote"===c.queryMode&&e.rangeChanged&&e.rangeChanged({startTime:this.range.startTime,endTime:this.range.endTime})},c.placeEvents=function(e){d(e),s(e)},c.placeAllDayEvents=function(e){d(e)}}]).directive("calendar",function(){"use strict";return{restrict:"EA",replace:!0,templateUrl:"template/rcalendar/calendar.html",scope:{calendarMode:"=",rangeChanged:"&",eventSelected:"&",timeSelected:"&"},require:["calendar","?^ngModel"],controller:"ui.rCalendar.CalendarController",link:function(e,t,a,n){var r=n[0],l=n[1];l&&r.init(l),e.$on("changeDate",function(e,t){r.move(t)}),e.$on("eventSourceChanged",function(e,t){r.onEventSourceChanged(t)})}}}).directive("weekview",["dateFilter","$timeout",function(e,t){"use strict";return{restrict:"EA",replace:!0,templateUrl:"template/rcalendar/week.html",require:"^calendar",link:function(a,n,r,l){function o(){var e=n.children(),t=e[1],r=t.offsetWidth-t.clientWidth,l=r||0;l>0&&(a.gutterWidth=l,0>=r?a.normalGutterWidth=l:a.normalGutterWidth=0)}function i(e,t){var a=new Array(t),n=new Date(e),r=0;for(n.setHours(12);t>r;)a[r++]={date:new Date(n)},n.setDate(n.getDate()+1);return a}function d(e){for(var t,a,n=[],r=9,l=e.getDate(),o=0,i=0;9>i;i+=1){t=[];for(var d=0;7>d;d+=1)o++,a=new Date(e.getTime()),a.setHours(r+i),a.setDate(l+d),t.push({time:a,index:o});n.push(t)}return n}function s(e){var t=new Date(e);t.setDate(t.getDate()+4-(t.getDay()||7));var a=t.getTime();return t.setMonth(0),t.setDate(1),Math.floor(Math.round((a-t)/864e5)/7)+1}a.formatWeekViewDayHeader=l.formatWeekViewDayHeader,a.formatHourColumn=l.formatHourColumn,l.mode={step:{days:7}},a.select=function(e,t){a.selectedCell=t,a.timeSelected&&a.timeSelected({selectedTime:e})},l._onDataLoaded=function(){var e,n,r,i=l.eventSource,d=i?i.length:0,s=l.range.startTime,c=l.range.endTime,u=-(new Date).getTimezoneOffset(),m=new Date(s.getTime()+60*u*1e3),v=new Date(c.getTime()+60*u*1e3),f=a.rows,h=a.dates,g=36e5,p=864e5,w=.016,D=!1,y=!1;if(f.hasEvent){for(n=0;7>n;n+=1)for(r=0;9>r;r+=1)f[r][n].events&&(f[r][n].events=null);f.hasEvent=!1}if(h.hasEvent){for(n=0;7>n;n+=1)h[n].events&&(h[n].events=null);h.hasEvent=!1}for(var M=0;d>M;M+=1){var C=i[M],b=new Date(C.startTime),k=new Date(C.endTime);if(C.allDay){if(m>=k||b>=v)continue;D=!0;var $;$=m>=b?0:Math.floor((b-m)/p);var x;x=k>=v?Math.ceil((v-m)/p):Math.ceil((k-m)/p);var E={event:C,startIndex:$,endIndex:x};e=h[$].events,e?e.push(E):(e=[],e.push(E),h[$].events=e)}else{if(s>=k||b>=c)continue;y=!0;var T;T=s>=b?0:(b-s)/g;var W;W=k>=c?(c-s)/g:(k-s)/g;var S,V=Math.floor(T),H=Math.ceil(W-9-w),I=V%3,_=Math.floor(V/24),N=24*_;do{N+=24,S=H>=N?24:H%24;var q={event:C,startIndex:I,endIndex:S};e=f[I][_].events,e?e.push(q):(e=[],e.push(q),f[I][_].events=e),I=0,_+=1}while(H>N)}}if(y)for(n=0;7>n;n+=1){var A=[];for(r=0;9>r;r+=1)f[r][n].events&&(A=A.concat(f[r][n].events));A.length>0&&(f.hasEvent=!0,l.placeEvents(A))}t(function(){o()})},l._refreshView=function(){var t,n,r=l.range.startTime,o=i(r,7),c="w";a.rows=d(r),a.dates=o,t=l.formatWeekTitle.indexOf(c),n=e(r,l.formatWeekTitle),-1!==t&&(n=n.replace(c,s(r))),n=n.replace(",",", Semana"),a.$parent.title=n},l._getRange=function(e){var t=e.getFullYear(),a=e.getMonth(),n=e.getDate(),r=e.getDay(),l=new Date(t,a,n-r),o=new Date(t,a,n-r+7);return{startTime:l,endTime:o}},l.refreshView()}}}]),angular.module("template/rcalendar/calendar.html",[]).run(["$templateCache",function(e){e.put("template/rcalendar/calendar.html",'<div ng-switch="calendarMode">\n    <div class="row ">\n        <div class="col s4 m2 l2">\n            <a tooltipped  data-position="top" data-delay="500" data-tooltip="Semana anterior" type="button" class="btn btn-default" ng-click="move(-1)"><i\n                    class="material-icons">keyboard_arrow_left</i></a>\n        </div>\n        <div class="calendar-header col s4 m8 l8">{{title}}</div>\n        <div class="col s4 m2 l2 right-align">\n            <a tooltipped  data-position="top" data-delay="500" data-tooltip="Siguiente semana" type="button" class="btn btn-default" ng-click="move(1)"><i\n                    class="material-icons">keyboard_arrow_right</i></a>\n        </div>\n    </div>\n    <weekview ng-switch-when="week"></weekview>\n</div>\n')}]),angular.module("template/rcalendar/week.html",[]).run(["$templateCache",function(e){e.put("template/rcalendar/week.html",'<div>\n    <table class="table table-fixed">\n        <thead>\n        <tr>\n            <th class="calendar-hour-column weekview-header-label">Hora</th>\n            <th ng-repeat="dt in dates" class="text-center weekview-header-label">{{dt.date| date:\n                formatWeekViewDayHeader}}\n            </th>\n            <th ng-if="gutterWidth>0" class="gutter-column" ng-style="{width: gutterWidth+\'px\'}"></th>\n        </tr>\n        </thead>\n    </table>\n    <div class="scrollable" style="height: 400px">\n        <table class="table table-bordered table-fixed">\n            <tbody>\n            <tr ng-repeat="row in rows track by $index">\n                <td class="calendar-hour-column text-center">\n                    {{row[0].time | date: formatHourColumn}}\n                </td>\n                <td ng-repeat="tm in row track by tm.time" ng-class="{\'cyan\':selectedCell==tm.index, \'accent-4\':true}" ng-click="select(tm.time, tm.index)">\n                  <div ng-class="{\'calendar-event-wrap\': tm.events, \'not-active\': true}" ng-if="tm.events">\n                        <div ng-click="$event.stopPropagation();" ng-repeat="displayEvent in tm.events" class="calendar-event"\n                             ng-style="{left: -7+\'%\', width: 115/displayEvent.overlapNumber+\'%\', height: 3.55*((displayEvent.endIndex)-displayEvent.startIndex)+\'em\', top: -26+\'px\'}">\n                            <div class="calendar-event-inner grey lighten-1">{{displayEvent.event.title}}</div>\n                    </div>\n                </td>\n                <td ng-if="normalGutterWidth>0" class="gutter-column" ng-style="{width: normalGutterWidth+\'px\'}"></td>\n            </tr>\n            </tbody>\n        </table>\n    </div>\n</div>')}]);